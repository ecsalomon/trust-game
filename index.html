<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
        var $j = jQuery.noConflict();
    </script>
    <script src="pixi.dev.js"></script>
</head>

<body>
    <script>
        
        // *** Initialize variables ***
        var score = 0; // how many tickets has the player won so far?
        var punish = 0; // did the player punish Player 2 this round? 0 = no; 1 = yes
        var trainingCondition = "${e://Field/training}"; // pull in training condition from Qualtrics
        var controllerCount = 0; // how many times has the player been Controller?
        var controllerMax = 15; // how many times should the player be Controller?
        var roundMax = 30; // how many rounds will the player play?
            
        // file paths to all the avatars
        var avatar1 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_4VMOAvQA1AESFJX";
        var avatar2 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_a8E4fq4HMIw3wRn";
        var avatar3 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_41qtXpnDxiLoTnT";
        var avatar4 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_57M3YRh0kfWpdpr";
        var avatar5 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_3sWu55iUZaIVoJn";
        var avatar6 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_e3su4OeukxIY9CZ";
        var avatar7 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_0oiJckoSOfpKTnD";
        var avatar8 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_9KuZG4ekZd4UWGx";
        var avatar9 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_eX8CjocdADHCYdv";
        var avatar10 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_9RGuX0mrqkvMHYN";
        var avatar11 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_3BCvo7dbIcMxLeZ";
        var avatar12 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_0jOCzPpysN3F02h";
        var avatar13 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_cHZpTL2OKihmxKd";
        var avatar14 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_5osYMdT6CxqEGc5";
        var avatar15 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_dnaeU4f35tPXfaR";
        var avatar16 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_b2Z4JXCknJPFBrL";
        var avatar17 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_b2urm5wlLyXBPcp";
        var avatar18 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_8kLN8v8UlC6NoQ5";
        var avatar19 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_5vZBKB7NkJ1mjs1";
        var avatar20 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_1ZddqNgJpNe5afP";
        var avatar21 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_9zC1P1OSQ05U3fn";
        var avatar22 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_8IbWG9VRYKB3Dbn";
        var avatar23 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_5orljVA2e8OIa7X";
        var avatar24 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_5swzD2G4puy2fDn";
        var avatar25 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_9vu3Mfg7NUSyaJT";
        var avatar26 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_3IBZ3muYDPZqDKR";
        var avatar27 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_2nLEiQXvtriNBMF";
        var avatar28 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_0PzlS9rV8wBfWS1";
        var avatar29 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_5guGfZ9AsYZZhQh";
        var avatar30 = "https://s.qualtrics.com/ControlPanel/File.php?F=F_1HN5ae178prwa8J";
       
        // create an array of the file paths
        var avatars = [avatar1, avatar2, avatar3, avatar4, avatar5, avatar6, avatar7, avatar8, avatar9, avatar10, avatar11, avatar12, avatar13, avatar14, avatar15, avatar16, avatar17, avatar18, avatar19, avatar20, avatar21, avatar22, avatar23, avatar24, avatar25, avatar26, avatar27, avatar28, avatar29, avatar30];
        
        // *** Load Function ***
        // When the page loads, show the avatar selection interface
        $j(function(){
            console.log("ready!");
            $j("#giveInterface").hide();
            $j("#waitForReturn").hide();
            $j("#returnedTickets").hide();
            $j("#matchingPlayers").hide();
            $j("#avatarBox").hide();
            $j("#player2image").hide();
        })
        
        function SpriteSheet(path, frameWidth, frameHeight) {
            var image = new Image();
            var framesPerRow;
            
            // calculate the number of frames in a row after the image loads
            var self = this;
            image.onload = function() {
             framesPerRow = Math.floor(image.width / frameWidth);
             };
                
            image.src = path;
        }
        
        // display to the player how many tickets they are giving away
        function outputUpdate(give) {
            document.querySelector('#currentGiveValue').value = give;
        }
        
        // Play a round
        function playRound(round){
            // Generate a random number from 10000 to 15000 that defines how
            // many ms player waits before Player 2 supposedly joins the game
            var playerWaitTime = Math.floor(Math.random() * 5000) + 10000;
            console.log(playerWaitTime);
            
            // randomly select an avatar for Player 2
            var player2 = Math.floor(Math.random()*30);
            var player2uri = avatars[player2];
            console.log(player2);
            
            var sentTickets = 0; // how many tickets has the player sent this round?
            var returnedTickets = 0; // how many tickets returned to the player this round?
            
            // is the player Controller this round? 0 = no; 1 = yes
            // first, initialize the variable to 0
            var controller = 0;
            // then, check if the number of rounds remaining is the same as
            // the number of controller rounds remaining, make the player
            // controller. if not, randomize whether the player is controller.
            var roundsRemaining = roundMax - round + 1; // how many rounds remaining?
            var controllersRemaining = controllerMax - controllerCount; // how many controller rounds remaining?
            if ( roundsRemaining <= controllersRemaining){
                controller = 1;
            } else if (controllerCount < controllerMax){
                controller = Math.round(Math.random() );
            }
            console.log(controller);
            
            
            
            // When the round begins, hide the avatar selection and show the
            // player that they are assigned to Player 1
            $j("#selectAvatar").hide();
            $j("#matchingPlayers").show();
            $j("#matchRoundNumber").text(round);
            $j("#roundNumber").text(round);
            
            // tell the player whether they are the controller
            if (controller == 1){
                $j("#youAreNotController").hide();
                $j("#youAreController").show();
            } else {
                $j("#youAreNotController").show();
                $j("#youAreController").hide();
            }
            
            // after 10-15 seconds, the round begins
            setTimeout(function(){
		$j("#matchingPlayers").hide();
                $j("#giveInterface").show();
                $j("#avatarBox").show();
                $j("#scoreValue").text(score);
                $j('#player2image').attr('src', player2uri);
                $j('#player2image').show();
                
                
	    },playerWaitTime);
            
        }
    </script>
    
    
    <div id="gameboard">
      <span id="roundTitle">Round: <span id="roundNumber"></span></span>
      <div id="rightBox" style="float:right;">
          <div id="scoreBox">Score<br><span id="scoreValue"></span></div>
          <div id="avatarBox" >Player 2<br><img id="player2image"></div>
      </div>
      <br><br>
      <div id="message" style="width:80%;">
          <div id="giveInterface">
              You have been given 10 raffle tickets.<br><br>
              How many tickets will you <span style="font-weight:bold;">give</span> to Player 2?<br><br>
              <div class="range-slider" data-slider>
                  <input type="range" id="giveNumber" min=0 max=10 step=1 value=0 oninput="outputUpdate(value)">
                      <output for="giveNumber" id=currentGiveValue>0</output>
              </div><br>
              <input id="giveButton" type="submit" value="Send">
          </div>
          <div id="waitForReturn">
              Player 2 has received <span id="receiveNumber"></span> tickets.<br>
              Waiting for Player 2 to move. . . .<br>
              <progress id="waitingForPlayer2"></progress>
          </div>
          <div id="returnedTickets">
              Player 2 has returned <span id="returnedNumber"></span> tickets to you.<br>
              <div id="controllerOption">
                You may punish player 2 by taking away <span id="punishmentNumber"></span> of their tickets. Would you like to do this?<br>
                    <input id="punishButton" type="submit" value="Yes"><input id="notPunish" type="submit" value="No">
              </div>
          </div>
          <!-- When players start, they select an avatar to represent themselves in game -->
          <div id="selectAvatar">
            You have been assigned to the role of Player 1!<br>
            Select an avatar to represent yourself in the game. This avatar will be shown to the players you are matched with.<br><br>
            <!-- Row 1 of avatars -->
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_4VMOAvQA1AESFJX"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_a8E4fq4HMIw3wRn"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_41qtXpnDxiLoTnT"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_57M3YRh0kfWpdpr"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_3sWu55iUZaIVoJn"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_e3su4OeukxIY9CZ"></a><br><br>
            <!-- Row 2 of avatars -->
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_0oiJckoSOfpKTnD"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_9KuZG4ekZd4UWGx"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_eX8CjocdADHCYdv"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_9RGuX0mrqkvMHYN"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_3BCvo7dbIcMxLeZ"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_0jOCzPpysN3F02h"></a><br>&nbsp;<br>
            <!-- Row 3 of avatars -->
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_cHZpTL2OKihmxKd"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_5osYMdT6CxqEGc5"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_dnaeU4f35tPXfaR"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_b2Z4JXCknJPFBrL"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_b2urm5wlLyXBPcp"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_8kLN8v8UlC6NoQ5"></a><br><br>
            <!-- Row 4 of avatars -->
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_5vZBKB7NkJ1mjs1"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_1ZddqNgJpNe5afP"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_9zC1P1OSQ05U3fn"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_8IbWG9VRYKB3Dbn"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_5orljVA2e8OIa7X"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_5swzD2G4puy2fDn"></a><br><br>
            <!-- Row 5 of avatars -->
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_9vu3Mfg7NUSyaJT"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_3IBZ3muYDPZqDKR"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_2nLEiQXvtriNBMF"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_0PzlS9rV8wBfWS1"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_5guGfZ9AsYZZhQh"></a>&nbsp;
            <a href="javascript:playRound(1)"><img src="https://s.qualtrics.com/ControlPanel/File.php?F=F_1HN5ae178prwa8J"></a>
          </div>
          <div id="matchingPlayers">
              <span id="youAreController"><span style="font-weight:bold;">You will be Controller this round!</span> If you feel Player 2 plays unfairly, you will have the opportunity to punish them when the round is over.</span>
              <span id="youAreNotController"><span style="font-weight:bold;">There will be no Controller this round.</span> The decisions made by both players will be final.</span>
              <br><br>
              Matching you with a player for Round <span id="matchRoundNumber"></span>. . . .<br><br>
              <progress id="matchingPlayers"></progress>
        </div>
    </div> 
</body>